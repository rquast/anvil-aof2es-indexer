# Anvil Connect ElasticSearch Indexer

## Description

The purpose of this daemon is to read and tail append only files (Redis AOF mode) generated by Anvil Connect, and send user, role and scope information to ElasticSearch. This gives you the ability to search on the metadata of users, roles, clients and scopes, which is not (currently) provided by the rest/v1 routes in Anvil Connect.

## Configuring ElasticSearch

The following changes must be made to elasticsearch.yml:

### Change the cluster name

```
cluster.name: anvilConnect
```

### Disable multicast discovery if running locally

```
discovery.zen.ping.multicast: false
```

## Running

Obtain the latest [jar binary](https://github.com/cavyio/anvil-aof2es-indexer/releases/latest), or compile with Maven.

```
mvn clean package
```

Run for the first time..

```
java -jar aof2es-[RELEASE].jar
```

This will create an ~/.aof2es directory with preferences.json and indexer.log files.

If your AOF file is not located in /var/lib/redis/appendonly.aof, edit the preferences file and re-run.

## Launching AOF2ES as a Daemon/Service

The project has a Commons Daemon implementation class. This means you can use either [jsvc (unix)](https://commons.apache.org/proper/commons-daemon/jsvc.html) or [procrun (windows)](http://yensee.com/web/creating-windows-service-using-apache-commons-daemon-and-calling-from-spring-schedular/) to launch the service on startup.

To do this, follow the instructions for using commons daemon and specify the class "com.aof2es.DaemonImpl".
